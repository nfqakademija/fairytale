language: php

php:
    - 5.4
    - 5.5
    - 5.6

addons:
    hosts:
        - fairytale
        - fairytale.dev

before_script:
    - pwd
    - wget https://apt.puppetlabs.com/puppetlabs-release-precise.deb
    - sudo dpkg -i puppetlabs-release-precise.deb
    - sudo apt-get update
    - sudo apt-get install puppet
    - gem install librarian-puppet
    - cd .vagrant && librarian-puppet install && librarian-puppet show && cd ..
    - sudo puppet apply .vagrant/manifests/default.pp --modulepath .vagrant/modules/ --parser future
    - sudo sed -i 's/listen = 127.0.0.1:9000/listen = \/var\/run\/php5-fpm.sock/g' /etc/php5/fpm/pool.d/www.conf
    - sudo service php5-fpm restart
    - sudo service nginx restart
    - composer install -n --prefer-source
    - sudo mkdir -p /var/www/ && sudo chmod 0777 /var/www/
    - ln -s /home/travis/build/nfqakademija/fairytale/ /var/www/fairytale.dev/

script:
    - bin/phpspec run -v -fpretty
#    - php bin/behat @NfqFairytaleApiBundle -v
    - curl http://fairytale.dev/ --fail

after_script:
    - cat /var/log/nginx/fairytale.dev.error.log
    - sudo cat /var/log/nginx/error.log
    - cat /var/log/nginx/fairytale.dev.access.log
    - cat /var/www/fairytale.dev/app/logs/dev.log
    - cat /etc/nginx/sites-enabled/fairytale.dev.conf
    - ls -lha /var/www/fairytale.dev/
